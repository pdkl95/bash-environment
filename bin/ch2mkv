#!/bin/bash

chkmkv() {
    mkvalidator --no-warn --quiet "$1"
}

cleanmkv() {
    /root/mkclean --remux --optimize "$1" "$2"
}

remux_into_mkv() {
    echo mkvmerge -o "$2" "$1"
    mkvmerge -o "$2" "$1"
}

convert_to_mkv() {
    local file="$1" dst tmp1

    if [[ ! -f "$1" ]] ; then
        echo "ERROR: not a file: '$file'"
        exit -1
    fi

    tmp1="$(tempfile --mode 0644 --prefix=ch2mkv_ --suffix=.mkv)"
    tmp2="$(tempfile --mode 0644 --prefix=ch2mkv_ --suffix=.mkv)"

    dst="${file%.*}.mkv"

    cleanup_tmp() {
        [ -f "$tmp1" ] && rm -f -- "$tmp1"
        [ -f "$tmp2" ] && rm -f -- "$tmp2"
    }
    trap cleanup_tmp RETURN

    echo ">>> *** change to MKV ***"
    echo ">>>\\"
    echo ">>> +"
    echo ">>> |  input: '$file'"
    echo ">>> | output: '$dst'"
    echo ">>> | (tmp1): '$tmp1'"
    echo ">>> | (tmp2): '$tmp2'"
    echo ">>> +"
    echo ">>>/"
    echo ">>> remuxing with mkvmerge..."
    remux_into_mkv "$file" "$tmp1"
    cleanmkv "$tmp1" "$tmp2"

    echo ">>> validating the results..."
    if chkmkv "$tmp2" ; then
        echo ">>> moving '$tmp2' -> '$dst'"
        mv -f -- "$tmp2" "$dst"

        if [[ "$file" == "$dst" ]] ; then
            echo ">>> original already overwritten"
        else
            echo ">>> removing original: '$file'"
            rm -f -- "$file"
        fi
    else
        echo "ERROR: created mkv is invalid!"
        rm -rf $tmp1 $tmp2
        exit 0
    fi
}


if [[ $# -lt 1 ]] ; then
    find . -type f -name '*.avi' -o -name '*.mp4' | xargs -n 1 ch2mkv
else
    for arg in "$@" ; do
        convert_to_mkv "$arg"
    done
fi
