#!/usr/bin/env bash

case "$0" in
    *HTML) FMT=html        DSTYLE=native   ;;
#    colorize256)  FMT=terminal256 DSTYLE=friendly ;;
    *256)  FMT=terminal256 DSTYLE=twilight ;;
    *16)   FMT=terminal    DSTYLE=native   ;;
    *)
        if [[ "$TERM" =~ 256 ]] ; then
            exec colorize256 "$@"
        else
            exec colorize16 "$@"
        fi
esac

while (( $# > 0 )) ; do
    case $1 in
        -h | --help)    echo -e "$USAGE"   ;  exit 0 ;;
        -V | --version) echo -e "$VERSION" ;  exit 0 ;;
        -f | --format)  FMT="$2"           ; shift 2 ;;
        -S | --style)   STYLE="$2"         ; shift 2 ;;
        -D | --dstyle)  DSTYLE="$2"        ; shift 2 ;;
        -l | --lexer)   LEXER="$2"         ; shift 2 ;;
        --) shift ; break ;;
        -*) echo "bad opt: $1" ; exit 1 ;;
        *)  break ;;
    esac
done


src="$1"
FILTER="tokenmerge"

[[ -z "$STYLE" ]] && STYLE="${DSTYLE}"
[[ -z "$LEXER" ]] && LEXER="$(pygmentize -N "$src")"


exec pygmentize                                                         \
    -l $LEXER                                                           \
    -f $FMT                                                             \
    -F "$FILTER"                                                        \
    -O "full,style=$STYLE"                                              \
    "$src"
